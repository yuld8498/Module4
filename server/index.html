<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/banking-ajax/boostrap/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="/banking-ajax/boostrap/css/bootstrap.min.css">
</head>

<body class="position-relative">
    <div class="table container">
        <div class="table-header">
            <div class="bg-info table-title">
                <div class="row">
                    <div class="col-5 table-title-content">
                        <h1>List Of Customer</h1>
                    </div>
                    <div class="col-7 table-title-content">
                        <div class="col-lg-5 float-right">
                            <button class="btn btn-outline-light mt-2" onclick="showBoxCreate()">
                                <i class="fa-solid fa-square-plus"></i>
                                <span>Add New Customer</span>
                            </button>
                        </div>
                        <div class="col-lg-7 float-left">
                            <a href="/customer/transfer" class="btn btn-outline-light float-right mt-2">
                                <i class="fa-solid fa-clock-rotate-left"></i>
                                <span>Transfer Money Infomation</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="table-tab">
                <table class="w-100" id="table">
                    <thead class="w-100 border-none align-middle" style="background-color: #4CAF50">
                        <tr class="float-center">
                            <th>#</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Balance</th>
                            <th colspan="4" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody class="w-100 align-middle">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Model Create -->
    <div class="modal fade " id="mdCreate" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Create Customer</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide">
                    </div>
                    <form id="frmTransfer">
                        <div class="row">
                            <div class="col-lg-6">
                                <input type="text" id="customerId" name="customerId" class="form-control" hidden>
                                <label for="fullName">Sender ID</label>
                                <input type="text" id="fullName" name="fullName" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="phone">Address</label>
                                <input type="text" id="address" name="address" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnCreate" class="btn btn-outline-primary">Create Customer</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Model Deposit -->
    <div class="modal fade " id="mdDeposits" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal Deposit</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide">
                    </div>
                    <form id="frmDeposit">
                        <div class="row">
                            <div class="col-lg-6">
                                <input type="hidden" id="customerIdDe" name="customerIdDe">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullNameDe" readonly class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="email">Email</label>
                                <input type="email" id="emailDe" name="emailDe" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-lg-6">
                                <label for="balance">Balance</label>
                                <input type="text" id="balanceDe" readonly class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmount">Transaction Amount</label>
                                <input type="text" id="transactionAmount" name="transactionAmount" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnDeposits" class="btn btn-outline-success">Deposits</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Model Withdraw -->
    <div class="modal fade " id="mdWithdraw" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Withdraw</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide">
                    </div>
                    <form id="frmWithdraw">
                        <div class="row">
                            <div class="col-lg-6">
                                <input type="hidden" id="customerIdWd">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullNameWd" readonly class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="email">Email</label>
                                <input type="email" id="emailWd" name="emailDe" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-lg-6">
                                <label for="phone">Balance</label>
                                <input type="text" id="balanceWd" readonly class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmount">Transaction Amount ($)</label>
                                <input type="text" id="transactionAmountWd" name="transactionAmountWd"
                                    class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnWithdraw" class="btn btn-outline-warning">Withdraw</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Model Transfer -->
    <div class="modal fade " id="mdTransfer" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Transfer</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide">
                    </div>
                    <form id="frmTransfer">
                        <div class="row">
                            <div class="col-lg-3">
                                <input type="hidden" id="customerIdT">
                                <label for="fullName">Sender ID</label>
                                <input type="text" id="senderId" readonly class="form-control">
                            </div>
                            <div class="col-lg-3">
                                <input type="hidden" id="customerIdT">
                                <label for="fullName">Sender Name</label>
                                <input type="text" id="senderName" readonly class="form-control">
                            </div>
                            <div class="col-lg-3">
                                <label for="email">Email</label>
                                <input type="email" id="senderEmail" name="senderEmail" class="form-control" readonly>
                            </div>
                            <div class="col-lg-3">
                                <label for="phone">Sender Balance</label>
                                <input type="text" id="senderBalance" readonly class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-lg-3">
                                <!-- <input type="hidden" id="recipientId"> -->
                                <label for="phone">Recipient Name</label>
                                <select type="select" id="recipientId" class="form-control">
                                </select>
                            </div>
                            <div class="col-lg-3">
                                <label for="transferAmount">Transfer Amount ($)</label>
                                <input type="text" id="transferAmount" name="transferAmount" class="form-control">
                            </div>
                            <div class="col-lg-3">
                                <label for="fees">Fees(%)</label>
                                <input type="text" id="fees" name="fees" class="form-control" readonly value=10>
                            </div>
                            <div class="col-lg-3">
                                <label for="totalAmount">Total amount($)</label>
                                <input type="text" id="totalAmount" name="totalAmount" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="btnTransfer" class="btn btn-outline-primary">Transfer</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/index.js"></script>
    <script src="/js.js"></script>
    <script src="/banking-ajax/boostrap/js/app.js"></script>
    <script src="/banking-ajax/boostrap/js/jquery-3.6.0.js"></script>
    <script src="/banking-ajax/boostrap/sweetalert2/sweetalert2.min.js"></script>
    <script src="/banking-ajax/boostrap/js/bootstrap.min.js"></script>
    <script src="/banking-ajax/boostrap/js/bootstrap.bundle.min.js"></script>
    <script src="/banking-ajax/boostrap/js/popper-v1.16.0.min.js"></script>
    <script src="https://kit.fontawesome.com/dccec83b30.js" crossorigin="anonymous"></script>
</body>
<script>
    // var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    // var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    //     return new bootstrap.Tooltip(tooltipTriggerEl)
    // })

    // $(".btnDeposits").on("click",function(){
    //     $("#mdDeposits").modal('show');
    //     var table = document.getElementById("table");
    //         document.getElementById("fullNameDe").value = table.rows[1].cells[1].innerHTML;
    //         document.getElementById("emailDe").value = table.rows[1].cells[2].innerHTML;
    //         document.getElementById("balanceDe").value = table.rows[1].cells[5].innerHTML;
    // })




    //create a customer
    $("#btnCreate").on('click', function () {
        let customer = new Customer();
        customer.fullName = $("#fullName").val();
        customer.email = $("#email").val();
        customer.phone = $("#phone").val();
        customer.address = $("#address").val();
        customer.deleted = 0;
        customer.balance = 0;
        $.ajax({
            type: "POST",
            url: "http://localhost:3000/customers",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(customer)
        }).done((data) => {
            customer = data;
            $("#table tbody").prepend($(tempCustomer(customer.id, customer.fullName, customer.email, customer.phone, customer.address, customer.balance)));
        }).fail((jqXHR, textStatus) => {
            $("#modalCreateCustomer .modal-body .modal-alert-danger").empty();
            $("#modalCreateCustomer .modal-body .modal-alert-danger").removeClass("hide").addClass("show");

            let str = ``;
            $.each(jqXHR.responseJSON, function (key, value) {
                str += `<label id="${key}-error" class="error" for="${key}">${value}</label>`;
                $("#" + key).addClass("error");
            });
            $("#modalCreateCustomer .modal-body .modal-alert-danger").html(str);
        });
        loadCustomer();
    })

    $("#btnDeposits").on('click', function () {
        let customer = new Customer();
        customer.id = $("#customerIdDe").val();
        let transactionAmount = $("#transactionAmount").val();
        if (Number.isNaN(+transactionAmount)) {
            App.showErrorAlert("'" + transactionAmount + "' is not a number, please enter a number!");
        } else if (+ transactionAmount < 1000) {
            App.showErrorAlert("transaction Amount is greater than 1000");
        }
        else {
            $.ajax({
                type: "GET",
                "url": "http://localhost:3000/customers/" + customer.id
            }).done((data) => {
                customer = data;
                customer.balance = (+customer.balance) + (+transactionAmount);
                $.ajax({
                    type: "PATCH",
                    "url": "http://localhost:3000/customers/" + customer.id,
                    data: customer
                }).done((data) => {
                    App.showSuccessAlert("Deposit is successfully");
                }).fail((error) => {
                    App.showErrorAlert("Deposit is fail");
                })
            }).fail((error) => {
                App.showErrorAlert("Deposit is fail");
            })
        }
    })
    $("#btnWithdraw").on('click', function () {
        let customer = new Customer();
        customer.id = $("#customerIdWd").val();
        let transactionAmount = $("#transactionAmountWd").val();
        if (Number.isNaN(+transactionAmount)) {
            App.showErrorAlert("'" + transactionAmount + "' is not a number, please enter a number!");
        } else if (+ transactionAmount < 100) {
            App.showErrorAlert("transaction Amount is greater than 100");
        }
        else if (+ transactionAmount > $("#balanceWd").val()) {
            App.showErrorAlert("transaction Amount is less than balance");
        }
        else {
            $.ajax({
                type: "GET",
                "url": "http://localhost:3000/customers/" + customer.id
            }).done((data) => {
                customer = data;
                customer.balance = +(customer.balance) - +(transactionAmount);
                $.ajax({
                    type: "PATCH",
                    "url": "http://localhost:3000/customers/" + customer.id,
                    data: customer
                }).done((data) => {
                    App.showSuccessAlert("Withdraw is successfully");
                }).fail((error) => {
                    App.showErrorAlert("Withdraw is fail");
                })
            }).fail((error) => {
                App.showErrorAlert("Withdraw is fail");
            })
        }
    })
    $("#btnTransfer").on('click', function () {
        let sender = new Customer();
        let recipient = new Customer();
        let senderId = $("#senderId").val();
        let recipientId = $("#recipientId").val();
        let transferAmount = +($("#transferAmount").val());
        $.ajax({
            type: "GET",
            "url": "http://localhost:3000/customers/" + senderId
        }).done((data) => {
            sender = data;
            $.ajax({
                type: "GET",
                "url": "http://localhost:3000/customers/" + recipientId
            }).done((data) => {
                recipient = data;
                let total = transferAmount + transferAmount * 0.1;
                if (sender.balance < total) {
                    App.showErrorAlert("The sender's balance is not enough to make the transfer");
                } else {
                    sender.balance = (+sender.balance)-(+total);
                    recipient.balance = (+recipient.balance)+(+transferAmount);
                    $.ajax({
                        type: "PATCH",
                        "url": "http://localhost:3000/customers/" + senderId,
                        data: sender
                    }).done((data) => {
                        $.ajax({
                            type: "PATCH",
                            "url": "http://localhost:3000/customers/" + recipientId,
                            data: recipient
                        }).done((data)=>{
                            App.showSuccessAlert("Transfer is completed")
                        }).fail((error)=>{
                            App.showErrorAlert("Transfer is Error, please check again infomation")
                        })
                    }).fail((error)=>{
                        App.showErrorAlert("Transfer is Error, please check again infomation")
                    })
                }
            }
            ).fail((error) => {
                App.showErrorAlert("can't find recipient");
            });
        }
        ).fail((error) => {
            App.showErrorAlert("can't find sender");
        });
    })
    function suspended(id) {
        App.showDeleteConfirmDialog()
            .then((result) => {
                if (result.isConfirmed) {
                    return $.ajax({
                        "type": "GET",
                        "url": "http://localhost:3000/customers/" + id
                    })
                        .done((data) => {
                            customer = data;
                        })
                        .fail((error) => {
                            App.showErrorAlert('Invalid ID customer');
                        }).then(() => {
                            customer.deleted = 1;
                            $.ajax({
                                "type": "PUT",
                                "url": "http://localhost:3000/customers/" + id,
                                "data": customer
                            })
                                .done((data) => {
                                    $('#tr_' + customerId).remove();

                                    App.showSuccessAlert('The customer has been deactived');
                                })
                                .fail((error) => {
                                    App.showErrorAlert('Deactive customer fail');
                                });
                        })
                }
            })
    }

    loadCustomer();
</script>

</html>